Alexa工具条分析

> 获取aid部分代码分析，考虑aid的可用性，建议编写一个插件小范围安装然后收集。
> 
> toolbar逻辑
> 
> 1. AID获取
>    - 初始化插件之后，在init阶段发送获取aid的请求。
> 
> 
> - 后续只有重新激活插件，或者卸载重装才会再次获取。
> 
> 
> 1. init_pinger 
>    
>    * 每小时调用一次dailyjob(`PING_DELAY = 86400000 / 24`搞不明白 每小时调用为何是dailyjob呢)
>      
>    * dailyjob 部分逐层调用分析（此部分可策略性跳过，每1小时停止刷新即可，下个周期换AID）
>      
>      * ``` javascript
>        function dailyJob() //原始写法 dailyJob: function()
>        {
>          ALX_NS_PH_TB_Helper.getGIURls();
>          ALX_NS_PH_TB_Helper.getPlatformXml();
>          ALX_NS_PH_TB_Helper.getToolbarPointerXml();
>          ALX_NS_PH_TB_Helper.getLocaleXml( false, false );
>          ALX_NS_PH_TB_Helper.ping();//?这里干了什么
>          if (  "ALX_NS_PH_TB" == "TBPLATFORM_NS_PH_TB" || 
>              ALX_NS_PH_TB_Helper.getPref("getHttpsDataList", false) || 
>              ALX_NS_PH_TB_Helper.getPref("display-style", "toolbar") == "statusbar" )
>          {
>            ALX_NS_PH_TB_Helper.getSearchConfJs();
>            ALX_NS_PH_TB_Helper.getHttpsDataList();
>          }
>        }
>        ```
>        
>      * ``` javascript
>        ping: function(isNew)
>        {
>          var isErrorHandling = false;
>          var errorConfName = "extensions.alexa.error-handling";
>          if ( ALX_NS_PH_TB_Helper.getPref( errorConfName, false ) )
>            isErrorHandling = true;
>          var toolbar_locale = ALX_NS_PH_TB_Helper.getPref("toolbarLocale", "default");
>        
>          var params = [
>            "dad=" + ( ALX_NS_PH_TB_Helper.needDataRequests() ? "1" : "0" ),
>            "search_provider=" + ( false ? "1" : "0"),
>            "error_handling=" + (isErrorHandling ? "1" : "0"),
>            "toolbar_locale=" + toolbar_locale
>          ]
>        
>          if (isNew)
>            params.push("new=1");
>        
>          ALX_NS_PH_TB_Helper.log("ping", params.join("&"));
>        }
>        ```
>        
>      * ``` javascript
>        log: function(prefix, extra)
>        {
>        var aid = ALX_NS_PH_TB_Helper.getPref("extensions.alexa.session", "");
>        var params = [
>        "aid=" + encodeURIComponent(aid),
>        "plugin=" + encodeURIComponent(ALX_NS_PH_TB_Helper.getMyVersion()),
>        "random=" + ALX_NS_PH_TB_Helper.getRandom(),
>        extra
>        ];
>        var logurl = "https://log.alexa.com/" + prefix + "/?" + params.join("&");
>        ALX_NS_PH_TB_Helper.sendRequest("GET", logurl);//尽管发没HEADER信息
>        }
>        ```
>        
>      * ​
>    
> 2. ​

第一步：获取aId的ajax请求发起

``` javascript
  requestSession: function()
  {
    if (ALX_NS_PH_TB_Helper.sessionRequested)
      return;

    ALX_NS_PH_TB_Helper.sessionRequested = true;
    var pref = "extensions.alexa.session";
    var version = ALX_NS_PH_TB_Helper.getMyVersion();
    var session_in_store = ALX_NS_PH_TB_Helper.getPref(pref, "");

    if ( !session_in_store || session_in_store.length == 0 )
    {
      var src = ALX_NS_PH_TB_Helper.baseline + "?cli=10&stc";
      var onload_requestSession  = function ()
      {
        if (this.readyState == 4)
        {
          if ( "OK" == this.statusText )
          {
       		//直接解析xml，然后写入本地缓存。
            var session = this.responseXML.documentElement.attributes.getNamedItem("AID").value;
            if (session && session != "=")
            {
              ALX_NS_PH_TB_Helper.setPref( pref, session );
            }
          }
        }
      }
	  //1⃣️.注意看这里：没有添加其余的Header信息
      ALX_NS_PH_TB_Helper.sendRequest("GET", src, onload_requestSession)

    }
    else
      ALX_NS_PH_TB_Helper.init_pinger();
  },
```

第二步，发送请求部分

``` javascript
  sendRequest: function(method, url, func, data, headers, isSync)
  {
    var xhr = new XMLHttpRequest();
    var async = true; 
    if (isSync == true)
      async = false;

    xhr.open(method, url, async);

    //2⃣️.这里接受回调
    if (func)
      xhr.onreadystatechange = func;
    else
      xhr.onreadystatechange = function() {};

    if (typeof headers == "object")
    {
      for (var key in headers)
      {
        var value = headers[key];
        xhr.setRequestHeader(key, value);
      } 
    }

    var payload = null;
    if (typeof data == "string")
      payload = data
    xhr.send(payload)
  }
```

**测试** _基于curl模拟结果_

``` bash
➜  ~  curl --user-agent "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:44.0) Gecko/20100101 Firefox/44.0" "https://data.alexa.com/data?cli=10&stc" -v
*   Trying 54.225.152.223...
* Connected to data.alexa.com (54.225.152.223) port 443 (#0)
* TLS 1.2 connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
* Server certificate: *.alexa.com
* Server certificate: RapidSSL SHA256 CA - G3
* Server certificate: GeoTrust Global CA
> GET /data?cli=10&stc HTTP/1.1
> Host: data.alexa.com
> User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:44.0) Gecko/20100101 Firefox/44.0
> Accept: */*
>
< HTTP/1.1 200 OK
< Content-Type: text/xml
< Date: Sun, 31 Jan 2016 00:54:31 GMT
< Server: nginx
< Set-cookie: aid=7JlHm1B95im3gL; domain=.alexa.com; path=/; expires=Sun Jan 31 00:54:31 2018
< Set-cookie: aid=7JlHm1B95im3gL; domain=.alexa.com; path=/; expires=Tue Feb  2 00:54:31 2016
< Content-Length: 200
< Connection: keep-alive
<
<?xml version="1.0" encoding="UTF-8"?>

<!-- Need more Alexa data?  Find our APIs here: https://aws.amazon.com/alexa/ -->
<ALEXA VER="0.9" URL="404" HOME="0" AID="7JlHm1B95im3gL" IDN="">

* Connection #0 to host data.alexa.com left intact
</ALEXA>%
```

至此，AID获取部分讨论结束。



模拟参数：

> 这里是重点：
> 
> 从overlay.js message.js